# MaaFGO 项目目标

## 项目愿景

在 MaaFramework 框架下，完整实现 FGO-py 的所有功能，提供跨平台的 FGO 自动化解决方案。

## 核心目标

### 1. 完整功能迁移

将 FGO-py 的全部功能迁移到 MaaFramework 架构：

| 功能模块 | FGO-py 来源 | 迁移状态 |
|----------|-------------|----------|
| 设备控制 | `fgoDevice` | ✅ 已完成 |
| 图像识别 | `fgoDetect` | ✅ 已完成 |
| 战斗核心 | `fgoKernel.Turn` | ✅ 已完成 |
| 刷本逻辑 | `fgoKernel.Main/Battle` | ✅ 已完成 |
| 友情点召唤 | `fgoKernel.FPSummon` | ⏳ 进行中 |
| 邮箱收取 | `fgoKernel.Mail` | ⏳ 进行中 |
| 抽卡记录 | `fgoKernel.SummonHistory` | ⏳ 进行中 |
| 智能选卡 | `fgoKernel.ClassicTurn` | ✅ 已完成 |
| 技能释放 | `fgoKernel.Skill` | ✅ 已完成 |
| 宝具使用 | `fgoKernel.Hougu` | ✅ 已完成 |
| 御主技能 | `fgoKernel.MasterSkill` | ✅ 已完成 |

### 2. 多平台支持

- **Avalonia GUI**: 跨平台桌面应用 (Windows/macOS/Linux)
- **Python 脚本**: 命令行版本和自定义扩展
- **MaaPiCli**: 标准化 CLI 接口

### 3. 多服务器支持

| 服务器 | 代号 | OCR 模型 | 状态 |
|--------|------|----------|------|
| 简中服 | CN | zh_cn | ✅ |
| 日服 | JP | ja_jp | ✅ |
| 美服 | NA | en_us | ✅ |
| 台服 | TW | zh_tw | ✅ |

## 架构设计

### 技术栈

```
┌─────────────────────────────────────────────────────────────┐
│                    MaaFGO.Avalonia (GUI)                    │
├─────────────────────────────────────────────────────────────┤
│                      服务层 (Services)                       │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │ MaaService  │ BattleService│ConfigService│ LogService  │ │
│  │   核心封装   │   战斗逻辑   │   配置管理   │   日志管理   │ │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
│  ┌─────────────┬─────────────┬─────────────────────────────┐ │
│  │FriendService│CustomAction │                             │ │
│  │  好友选择   │  自定义动作  │                             │ │
│  └─────────────┴─────────────┴─────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│              MaaFramework.Binding (.NET)                    │
├─────────────────────────────────────────────────────────────┤
│                   MaaFramework (Native)                     │
├─────────────────────────────────────────────────────────────┤
│  Pipeline JSON  │  Image Templates  │  OCR Models           │
└─────────────────────────────────────────────────────────────┘
```

### 服务层设计

| 服务 | 职责 | 依赖 |
|------|------|------|
| `MaaService` | MaaFramework 核心封装（设备连接、任务执行、截图） | MaaFramework.Binding |
| `ConfigService` | 配置管理（战斗脚本、苹果策略、服务器设置） | - |
| `BattleService` | 战斗逻辑（技能释放、选卡策略、宝具使用） | MaaService |
| `FriendService` | 好友选择（助战筛选、刷新逻辑） | MaaService |
| `CustomActionService` | 自定义动作注册和管理 | MaaService |
| `LoggingService` | 统一日志管理 | Serilog |

## 功能规格

### 自动刷本 (Farming)

```
功能：自动循环刷取指定关卡
入口：Farming_Start
配置：
  - 刷本次数
  - 苹果策略（金/银/铜/彩虹/不吃）
  - 队伍配置
  - 技能脚本
流程：
  1. 检测当前界面状态
  2. 进入关卡
  3. 选择好友助战
  4. 开始战斗
  5. 执行回合（技能 + 选卡）
  6. 收集奖励
  7. 循环/结束
```

### 智能战斗 (SmartBattle)

```
功能：基于卡牌信息的智能选卡
算法：移植自 fgoKernel.ClassicTurn
考虑因素：
  - 卡牌颜色（Arts/Quick/Buster）
  - 克制关系（克制/被克/无效）
  - 暴击率
  - 同色链/Brave Chain
  - 首卡加成
  - 位置系数
```

### 技能释放 (SkillCast)

```
功能：从者技能和御主技能释放
技能类型：
  - 单体技能（无目标）
  - 目标技能（选择目标）
  - 换人技能（选择前排+后排）
脚本格式：
  - a: 技能1   b: 技能2   c: 技能3
  - 1: 从者1   2: 从者2   3: 从者3
  - j: 宝具1   k: 宝具2   l: 宝具3
  - 4/5/6: 后排从者
  - x: 衣服技能1  y: 衣服技能2  z: 衣服技能3
```

### 好友选择 (FriendSelect)

```
功能：自动选择合适的好友助战
筛选条件：
  - 从者职阶
  - 技能等级
  - 礼装匹配
  - 好友优先
刷新机制：
  - 无匹配时自动刷新
  - 刷新冷却处理
```

### 友情点召唤 (FPSummon)

```
功能：自动友情点召唤
入口：FPSummon_Start
流程：
  1. 进入召唤页面
  2. 选择10连召唤
  3. 确认召唤
  4. 跳过动画
  5. 循环直到友情点不足
```

### 邮箱收取 (MailCollect)

```
功能：自动收取邮箱奖励
入口：Mail_Start
流程：
  1. 进入邮箱
  2. 一键收取
  3. 确认收取
  4. 返回
```

## 配置文件

### interface.json

定义 MaaPiCli 标准接口配置，包括：
- 可用任务列表
- 配置选项
- 资源路径

### maa_pi_config.json

用户配置文件，包括：
- 设备连接信息
- 任务参数
- 服务器选择

## 开发路线图

### Phase 1: 核心功能 (已完成)
- [x] 设备控制层适配
- [x] 图像识别层适配
- [x] 基础战斗逻辑
- [x] Pipeline 任务流程

### Phase 2: GUI 开发 (进行中)
- [x] Avalonia 项目框架
- [x] MaaService 核心服务
- [ ] 完整服务层
- [ ] 主界面设计
- [ ] 任务配置界面
- [ ] 日志显示

### Phase 3: 完整功能
- [ ] 友情点召唤
- [ ] 邮箱收取
- [ ] 抽卡记录
- [ ] 活动任务

### Phase 4: 高级功能
- [ ] 战斗脚本编辑器
- [ ] 自动编队
- [ ] 素材规划
- [ ] 数据统计

## 参考资料

- [FGO-py 源码](../FGO-py/)
- [MaaFramework 文档](https://maafw.xyz/)
- [Pipeline 协议](https://github.com/MaaXYZ/MaaFramework/blob/main/docs/zh_cn/3.1-任务流水线协议.md)
