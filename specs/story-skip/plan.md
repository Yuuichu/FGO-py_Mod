# 实现计划: 剧情跳过 (Story Skip)

## 实现概述

基于现有实现进行优化和稳定化，确保剧情跳过功能在各种场景下可靠工作，同时不影响原有战斗和自动化逻辑。

## 阶段划分

### 阶段 1: 验证现有模板和检测逻辑

**目标**: 确认现有图像模板能正确匹配剧情界面

**涉及文件**:
- `FGO-py/fgoImage/storymenu.png`
- `FGO-py/fgoImage/storyskipbutton.png`
- `FGO-py/fgoImage/storyskipconfirm.png`
- `FGO-py/fgoDetect.py`

**实现步骤**:
1. 检查模板图像尺寸和质量
2. 验证检测区域 `(rect)` 参数是否正确
3. 调优匹配阈值 `(threshold)`
4. 使用 `test_story_detect.py` 测试

**检查点**:
- [ ] 模板文件存在且格式正确
- [ ] 检测方法能在测试截图上正确识别

### 阶段 2: 优化 skipStory 函数

**目标**: 提高跳过逻辑的可靠性

**涉及文件**:
- `FGO-py/fgoKernel.py`

**实现步骤**:
1. 检查 `skipStory()` 函数的逻辑流程
2. 确保正确处理"先检测确认弹窗再检测跳过按钮"的顺序
3. 添加适当的等待时间确保点击生效
4. 添加日志记录便于调试

**检查点**:
- [ ] 函数能正确处理跳过按钮
- [ ] 函数能正确处理确认弹窗
- [ ] 日志输出清晰

### 阶段 3: 验证多场景集成

**目标**: 确保剧情跳过在各个调用点正常工作

**涉及文件**:
- `FGO-py/fgoKernel.py`

**实现步骤**:
1. 验证 `Battle.__call__` 中的集成
2. 验证 `Main.__call__` 中的集成
3. 验证 `Main.chooseFriend` 中的集成
4. 确保检测优先级正确

**检查点**:
- [ ] 战斗中遇到剧情能跳过
- [ ] 选择助战时遇到剧情能跳过
- [ ] 不影响正常战斗流程

### 阶段 4: 代码审查和清理

**目标**: 确保代码质量和一致性

**涉及文件**:
- `FGO-py/fgoDetect.py`
- `FGO-py/fgoKernel.py`

**实现步骤**:
1. 检查是否有重复代码
2. 确保命名规范一致
3. 移除测试用的临时代码
4. 添加必要的注释

**检查点**:
- [ ] 代码无语法错误
- [ ] 代码风格与项目一致

## 检测方法说明

```python
# 剧情菜单检测 - 右下角区域
isStoryPlaying(): rect=(1000,400,1280,620), threshold=0.25

# 跳过按钮检测 - 右上角区域
isStorySkipButton(): rect=(1100,0,1280,100), threshold=0.05

# 确认弹窗检测 - 中间偏下区域
isStorySkipConfirm(): rect=(550,480,1000,620), threshold=0.05
```

## 点击坐标

| 元素 | 坐标 |
|------|------|
| 跳过按钮 | (1189, 44) |
| 确认弹窗"是" | (825, 557) |

## 依赖关系

- 依赖 `fgoDetect.py` 的 `_compare` 方法
- 依赖 `fgoDevice.device.touch` 进行点击
- 依赖 `schedule.sleep` 进行等待

## 测试策略

### 单元测试

- 使用 `test_story_detect.py` 测试模板匹配
- 使用不同服务器的截图验证兼容性

### 集成测试

- 在实际游戏中运行包含剧情的关卡
- 验证跳过后能正常继续

## 回滚计划

如果出现问题：
1. 设置 `Battle.skipStoryEnabled = False` 禁用功能
2. 或恢复 `fgoKernel.py` 到之前版本

## 时间估算

| 阶段 | 预估时间 |
|------|----------|
| 阶段 1: 验证模板 | 0.5 小时 |
| 阶段 2: 优化函数 | 0.5 小时 |
| 阶段 3: 验证集成 | 0.5 小时 |
| 阶段 4: 代码审查 | 0.5 小时 |
| **总计** | **2 小时** |
