# 功能规范: 剧情跳过 (Story Skip)

## 概述

优化 FGO-py 的剧情跳过功能，使其能够在战斗过程中、选择助战时、编队界面等多个场景下自动检测并跳过剧情，减少人工干预。

## 当前状态

已有初步实现：
- `fgoDetect.py`: `isStoryPlaying()`, `isStorySkipButton()`, `isStorySkipConfirm()` 方法
- `fgoKernel.py`: `skipStory()` 函数，已集成到 `Battle` 和 `Main` 类
- 图像模板: `storymenu.png`, `storyskipbutton.png`, `storyskipconfirm.png`

## 用户故事

### 故事 1: 战斗中剧情自动跳过

**作为** FGO-py 用户
**我希望** 在战斗进行中遇到剧情时能自动跳过
**以便** 无需人工干预即可完成包含剧情的关卡

#### 验收标准

- [ ] 能检测到剧情界面（右下角菜单按钮）
- [ ] 能检测到跳过按钮（右上角）
- [ ] 能检测并点击确认弹窗的"是"按钮
- [ ] 跳过后能正常继续战斗流程

### 故事 2: 主线关卡剧情跳过

**作为** FGO-py 用户
**我希望** 在刷主线关卡时自动跳过所有剧情
**以便** 能够全自动完成主线关卡

#### 验收标准

- [ ] 关卡开始前的剧情能被检测和跳过
- [ ] 关卡结束后的剧情能被检测和跳过
- [ ] 不影响正常的战斗检测逻辑

### 故事 3: 可配置的剧情跳过

**作为** FGO-py 用户
**我希望** 能够开关剧情跳过功能
**以便** 在需要观看剧情时可以关闭此功能

#### 验收标准

- [ ] 提供 `skipStoryEnabled` 配置项
- [ ] 配置可在运行时修改
- [ ] 默认启用剧情跳过

## 功能需求

### 必须实现

1. **稳定的剧情界面检测**
   - 使用 `STORYMENU` 模板检测右下角菜单按钮
   - 阈值调优确保准确率
   - 支持多服务器（CN/JP/NA/TW）

2. **跳过按钮检测与点击**
   - 检测右上角跳过按钮 `STORYSKIPBUTTON`
   - 点击位置: (1189, 44)

3. **确认弹窗处理**
   - 检测确认弹窗 `STORYSKIPCONFIRM`
   - 点击"是"按钮位置: (825, 557)

4. **多场景集成**
   - 战斗中 (`Battle.__call__`)
   - 选择助战时 (`Main.chooseFriend`)
   - 等待编队时

### 可选实现

1. 剧情界面的其他交互（如需要点击继续的剧情）
2. 日志记录跳过的剧情次数

## 技术约束

- 必须兼容 Python 3.11+
- 图像模板必须对应 1280×720 分辨率
- 不能影响现有战斗检测逻辑的优先级
- 检测延迟应控制在合理范围内

## 非功能需求

- **性能**: 剧情检测不应显著增加每帧检测时间
- **可靠性**: 误检率应低于 1%
- **兼容性**: 支持 CN/JP/NA/TW 四个服务器

## 相关文件

### 需要检查/修改的文件

- `FGO-py/fgoDetect.py` - 检测方法
- `FGO-py/fgoKernel.py` - 跳过逻辑和集成
- `FGO-py/fgoImage/storymenu.png` - 菜单按钮模板
- `FGO-py/fgoImage/storyskipbutton.png` - 跳过按钮模板
- `FGO-py/fgoImage/storyskipconfirm.png` - 确认弹窗模板
- 各服务器子目录下的对应模板（如存在差异）

## 风险与注意事项

1. **不同服务器的 UI 差异**: 日服/美服/台服的按钮位置和外观可能不同
2. **模板匹配阈值**: 过低会误检，过高会漏检
3. **剧情检测与战斗检测冲突**: 需要正确的检测优先级
4. **特殊剧情类型**: 某些剧情可能有不同的跳过方式
